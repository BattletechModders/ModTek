<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Library</OutputType>
    <TargetFramework>net472</TargetFramework>
    <LangVersion>7.3</LangVersion>
    <DebugType>none</DebugType>
    <Optimize>true</Optimize>
    <DebugSymbols>false</DebugSymbols>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <AssemblySearchPaths>$(BattleTechGameDir)\Mods\ModTek\AssembliesOverride;$(BattleTechGameDir)\BattleTech_Data\Managed\;$(AssemblySearchPaths)</AssemblySearchPaths>
    <DisableImplicitFrameworkReferences>true</DisableImplicitFrameworkReferences>
    <DoorstopIntDir>$(MSBuildProjectExtensionsPath)\doorstep</DoorstopIntDir>
  </PropertyGroup>

  <ItemGroup>
    <Link Include="$(BattleTechGameDir)\Mods\.modtek\ModTekPreloader*" />
    <Link Include="$(BattleTechGameDir)\Mods\ModTek\ModTekPreloader*" />
  </ItemGroup>

  <Target Name="CopyFilesToGame" AfterTargets="CopyFilesToOutputDirectory" Condition="'$(BattleTechGameDir)' != ''">
    <ItemGroup>
      <OutDirFiles Include="$(OutDir)**" />
      <DoorstopFiles Include="run.sh;doorstop_config.ini" />
    </ItemGroup>
    <Copy SourceFiles="@(OutDirFiles)" DestinationFolder="$(BattleTechGameDir)\Mods\ModTek\" />
    <Copy SourceFiles="@(DoorstopFiles)" DestinationFolder="$(BattleTechGameDir)\" />
<!--    <Copy SourceFiles="@(DoorstopFiles)" DestinationFolder="$(BattleTechGameDir)\doorstop\release" />-->
<!--    <Copy SourceFiles="@(DoorstopFiles)" DestinationFolder="$(BattleTechGameDir)\doorstop\verbose" />-->
  </Target>

  <Target Name="DoorstopFetch" BeforeTargets="CopyFilesToGame" Condition="'$(BattleTechGameDir)' != '' And !Exists('$(BattleTechGameDir)\winhttp.dll')">
    <PropertyGroup>
      <DoorstopUrl>https://github.com/CptMoore/UnityDoorstop/releases/download/latest/doorstop_all_in_one_4.0.1steamfix.zip</DoorstopUrl>
    </PropertyGroup>
    <DownloadFile SourceUrl="$(DoorstopUrl)" DestinationFolder="$(DoorstopIntDir)" />
    <Unzip SourceFiles="$(DoorstopIntDir)\doorstop_all_in_one_4.0.1steamfix.zip" DestinationFolder="$(DoorstopIntDir)" />
    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_win_release\x64\winhttp.dll" DestinationFolder="$(BattleTechGameDir)" />
    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_linux_release\x64\libdoorstop.so" DestinationFolder="$(BattleTechGameDir)" />
    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_macos_release\x64\libdoorstop.dylib" DestinationFolder="$(BattleTechGameDir)" />
<!--    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_win_release\x64\winhttp.dll" DestinationFolder="$(BattleTechGameDir)\doorstop\release" />-->
<!--    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_linux_release\x64\libdoorstop.so" DestinationFolder="$(BattleTechGameDir)\doorstop\release" />-->
<!--    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_macos_release\x64\libdoorstop.dylib" DestinationFolder="$(BattleTechGameDir)\doorstop\release" />-->
    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_win_verbose\x64\winhttp.dll" DestinationFolder="$(BattleTechGameDir)\doorstop\verbose" />
    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_linux_verbose\x64\libdoorstop.so" DestinationFolder="$(BattleTechGameDir)\doorstop\verbose" />
    <Copy SourceFiles="$(DoorstopIntDir)\doorstop_macos_verbose\x64\libdoorstop.dylib" DestinationFolder="$(BattleTechGameDir)\doorstop\verbose" />
  </Target>

  <Target Name="HarmonyFetch" BeforeTargets="PrepareForBuild" Condition="'$(BattleTechGameDir)' != '' And !Exists('$(BattleTechGameDir)\Mods\ModTek\AssembliesOverride\0Harmony.dll')">
    <PropertyGroup>
<!--      <HarmonyUrl>https://github.com/BattletechModders/ModTek/files/9563721/0Harmony.zip</HarmonyUrl>--><!-- fast harmony -->
      <HarmonyUrl>https://github.com/BattletechModders/ModTek/files/9619752/HarmonyXAssembliesOverride.zip</HarmonyUrl><!-- harmony12X-->
      <HarmonyIntDir>$(MSBuildProjectExtensionsPath)\harmony</HarmonyIntDir>
    </PropertyGroup>
    <DownloadFile SourceUrl="$(HarmonyUrl)" DestinationFolder="$(MSBuildProjectExtensionsPath)\harmony" />
    <Unzip SourceFiles="$(HarmonyIntDir)\HarmonyXAssembliesOverride.zip" DestinationFolder="$(HarmonyIntDir)" />
    <ItemGroup>
      <HarmonyFiles Include="$(HarmonyIntDir)\*.dll;$(HarmonyIntDir)\*.txt" />
    </ItemGroup>
    <Copy SourceFiles="@(HarmonyFiles)" DestinationFolder="$(BattleTechGameDir)\Mods\ModTek\AssembliesOverride" Condition="'$(BattleTechGameDir)' != ''" />
  </Target>

  <ItemGroup>
    <Reference Include="System">
      <Private>False</Private>
    </Reference>
    <Reference Include="System.Core">
      <Private>False</Private>
    </Reference>
    <Reference Include="Newtonsoft.Json">
      <Private>False</Private>
    </Reference>
    <Reference Include="0Harmony">
      <Private>False</Private>
    </Reference>
  </ItemGroup>
  <ItemGroup>
    <PackageReference Include="GitVersion.MsBuild" Version="5.10.3">
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="Mono.Cecil">
      <Version>0.10.4</Version>
    </PackageReference>
  </ItemGroup>
</Project>